<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>IPS ‚Äì Directorio WhatsApp iCUR@</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif
        }

        body {
            margin: 0;
            background: #eef3fb
        }

        header {
            background: #1f4fd8;
            color: #fff;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 25px
        }

        .card {
            background: #fff;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, .12);
            margin-bottom: 25px
        }

        textarea {
            width: 100%;
            min-height: 90px;
            padding: 14px;
            border-radius: 10px;
            border: 1px solid #ccc
        }

        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px
        }

        button {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer
        }

        .btn-blue {
            background: #1f4fd8;
            color: #fff
        }

        .btn-green {
            background: #25D366;
            color: #fff
        }

        .btn-green:disabled {
            background: #b7e6c9;
            cursor: not-allowed
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px
        }

        .contact {
            display: flex;
            position: relative;
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
            background: #fff;
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 6px 14px rgba(0, 0, 0, .08);
            border: 2px solid transparent;
            cursor: pointer
        }

        .contact input[type="checkbox"] {
            position: absolute;
            top: 12px;
            right: 12px;
            transform: scale(1.1);
        }

        .contact-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contact-info {
            line-height: 1.35;
        }

        .contact-info small {
            display: block;
            color: #666;
            font-size: 13px;
        }

        .contact-info .meta {
            margin-top: 6px;
        }

        .send-btn {
            margin-top: 10px;
            background: #16a34a;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .send-btn:hover {
            background: #12863e;
        }

        .send-btn img {
            width: 16px;
            filter: invert(1);
        }

        .contact.selected {
            border-color: #1f4fd8;
            background: #f4f7ff
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1f4fd8;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold
        }

        .contact-info {
            flex: 1
        }

        .contact-info small {
            color: #666
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, .85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #ccc;
            border-top-color: #1f4fd8;
            border-radius: 50%;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th,
        td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            font-size: 14px
        }

        th {
            background: #f4f7ff
        }

        footer {
            text-align: center;
            padding: 20px;
            font-size: 13px;
            color: #666
        }

        .wa-btn {
            background: #25D366;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .wa-btn img {
            width: 18px;
            filter: invert(1);
        }

        .wa-btn:hover {
            transform: scale(1.05);
        }

        #history td,
        #history th {
            text-align: center;
            vertical-align: middle;
        }

        #history td:nth-child(5) {
            text-align: left;
        }

        .send-main-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            font-size: 14px;
        }

        .send-main-btn img {
            width: 18px;
            height: 18px;
            filter: invert(1);
        }
    </style>
</head>

<body>

    <header>
        <h2>üì± Directorio WhatsApp ‚Äì IPS</h2>
        <div id="count">0 seleccionados</div>
    </header>

    <div class="container">

        <div class="card">
            <h3>‚úàÔ∏è Componer Mensaje</h3>
            <textarea id="message" maxlength="500" placeholder="M√°x. 500 caracteres..."></textarea>
            <div class="actions">
                <button class="btn-blue" onclick="toggleAll()">Seleccionar Todos</button>
                <button class="btn-green send-main-btn" id="sendBtn" disabled onclick="sendWhatsApp()">
                    <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/whatsapp.svg">
                    <span>Enviar por WhatsApp</span>
                </button>
            </div>
        </div>

        <div class="grid" id="contacts"></div>

        <div class="card">
            <h3>üìú Historial de Env√≠os</h3>
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Nombre</th>
                        <th>Tel√©fono</th>
                        <th>Mensaje</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="history"></tbody>
            </table>
        </div>

    </div>

    <div class="overlay" id="overlay">
        <div class="spinner"></div>
    </div>

    <footer>¬© 2026 IPS ‚Äì Innovaci√≥n en Seguridad Patrimonial</footer>

    <script>
        const contacts = [
            {
                name: "Daniel Ch√°varri",
                phone: "+51946118245",
                email: "daniel.chavarri@ips.com",
                address: "Av. Principal 123, Lima",
                role: "Supervisor IPS"
            },
            {
                name: "Carlos Ibarra",
                phone: "+51921872052",
                email: "carlos.ibarra@ips.com",
                address: "Jr. Central 456, Lima",
                role: "Operador iCUR@"
            },
            {
                name: "Benjamin Cavero",
                phone: "+51996381644",
                email: "benjamin.cavero@ips.com",
                address: "Calle Norte 789, Lima",
                role: "Seguridad Patrimonial"
            }
        ];

        const messageLog = []
        const container = document.getElementById("contacts")
        const history = document.getElementById("history")
        const counter = document.getElementById("count")
        const sendBtn = document.getElementById("sendBtn")
        const overlay = document.getElementById("overlay")

        function formatPhone(p = "") {
            return p.replace(/^(\+\d{2})(\d{3})(\d{3})(\d{3})$/, "$1 $2 $3 $4");
        }

        function render() {
            container.innerHTML = "";

            contacts.forEach((c, i) => {
                container.innerHTML += `
<div class="contact" id="c${i}" onclick="toggle(${i})">

  <input type="checkbox" id="chk${i}" onclick="event.stopPropagation()">

  <div class="contact-header">
    <div class="avatar">${c.name[0]}</div>
    <div>
        <strong>${c.name}</strong> <br>
        <small>üìû ${formatPhone(c.phone)}</small>
    </div>
  </div>

  <div class="contact-info meta">
    <small>üìß ${c.email}</small>
    <small>üìç ${c.address}</small>
  </div>

  <button class="send-btn"
    onclick="event.stopPropagation(); sendSingle(${i})">
    <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/whatsapp.svg">
    Enviar a ${c.name.split(" ")[0]}
  </button>

</div>`;
            });
        }

        function toggle(i) {
            const chk = document.getElementById("chk" + i)
            chk.checked = !chk.checked
            document.getElementById("c" + i).classList.toggle("selected", chk.checked)
            sendBtn.disabled = !chk.checked
            counter.textContent = chk.checked ? "1 seleccionado" : "0 seleccionados"
        }

        function toggleAll() {
            let anyUnchecked = contacts.some((_, i) =>
                !document.getElementById("chk" + i).checked
            );

            contacts.forEach((_, i) => {
                const chk = document.getElementById("chk" + i);
                const card = document.getElementById("c" + i);

                chk.checked = anyUnchecked;
                card.classList.toggle("selected", anyUnchecked);
            });

            sendBtn.disabled = !anyUnchecked;
            counter.textContent = anyUnchecked
                ? `${contacts.length} seleccionados`
                : "0 seleccionados";
        }

        function sendSingle(i) {
            document.getElementById("chk" + i).checked = true;
            toggle(i);
            message.focus();
        }

        function renderHistory() {
            history.innerHTML = "";

            messageLog.forEach(l => {
                const d = new Date(l.date);

                history.innerHTML += `
      <tr>
        <td>${d.toLocaleDateString("es-PE")}</td>
        <td>${d.toLocaleTimeString("es-PE")}</td>
        <td>${l.name}</td>
        <td>${formatPhone(l.phone)}</td>
        <td>${l.message}</td>
        <td style="color:${l.status === "enviado" ? "green" : "red"};font-weight:bold">
          ${l.status.toUpperCase()}
        </td>
      </tr>`;
            });
        }

        async function sendWhatsApp() {
            const msg = message.value.trim();
            if (!msg) return alert("Escribe un mensaje");

            overlay.style.display = "flex";

            try {
                const selected = contacts.filter((_, i) =>
                    document.getElementById("chk" + i).checked
                );

                const res = await fetch("https://ips-whatsapp-backend.onrender.com/send-whatsapp", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: msg, phones: selected })
                });

                const data = await res.json();

                data.results.forEach(r => {
                    messageLog.push({
                        date: r.date,
                        name: r.name,
                        phone: r.phone,
                        message: msg,
                        status: r.status
                    });
                });

                renderHistory();
                message.value = "";

            } catch (e) {
                alert("Error al enviar mensajes");
                console.error(e);
            } finally {
                overlay.style.display = "none";
            }
        }

        render()
    </script>

</body>

</html>